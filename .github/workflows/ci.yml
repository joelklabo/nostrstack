name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Lint (GitHub Actions Workflows)
            tool: actionlint
          - name: Lint (Knip)
            command: pnpm lint:knip
            allow_failure: true
          - name: Lint (Copy/Paste)
            command: pnpm lint:cpd
          - name: Lint (File Naming)
            command: pnpm lint:ls
          - name: Lint (Spell Check)
            command: pnpm lint:spell
          - name: Lint (CSS)
            command: pnpm lint:css
          - name: Lint (Markdown)
            command: pnpm lint:md
          - name: Lint (Shell Scripts)
            command: pnpm lint:sh
            install_shellcheck: true
          - name: Lint (Secrets)
            command: pnpm lint:secrets
          - name: Lint (Audit)
            command: pnpm lint:audit
          - name: Lint (Dependencies)
            command: pnpm lint:deps
          - name: Lint (Architecture)
            command: pnpm lint:dep
    permissions:
      contents: read
    continue-on-error: ${{ matrix.allow_failure }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Lint (GitHub Actions Workflows)
        if: matrix.tool == 'actionlint'
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: error
          filter_mode: nofilter

      - name: Install shellcheck
        if: matrix.install_shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: ${{ matrix.name }}
        if: matrix.command
        run: ${{ matrix.command }}

  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: TypeCheck
        run: pnpm typecheck

      - name: Lint (Publishing)
        run: pnpm lint:pub

      - name: Lint (Types)
        run: pnpm lint:attw

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Generate Prisma Client
        working-directory: apps/api
        env:
          DATABASE_URL: file:./test.db
          PRISMA_SCHEMA_FILE: prisma/schema.prisma
        run: pnpm prisma:generate

      - name: Cache Vitest
        uses: actions/cache@v4
        with:
          path: /tmp/nostrstack/vitest
          key: vitest-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/vitest.config.*', '**/*.test.ts', '**/*.test.tsx', '**/*.spec.ts', '**/*.spec.tsx') }}
          restore-keys: |
            vitest-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Lint (ESLint)
        run: pnpm lint

      - name: Unit Tests
        env:
          DATABASE_URL: file:./test.db
          ADMIN_API_KEY: test-admin
          OP_NODE_API_KEY: test-key
          OP_NODE_WEBHOOK_SECRET: whsec_test
          XDG_CACHE_HOME: /tmp
        run: pnpm test:ci

  smoke-lnbits:
    name: LNbits Smoke Test
    if: secrets.LNBITS_STG_ADMIN_KEY != ''
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Mutinynet smoke (staging LNbits)
        env:
          LNBITS_URL: https://lnbits-stg-west.thankfulwater-904823f2.westus3.azurecontainerapps.io
          LNBITS_ADMIN_KEY: ${{ secrets.LNBITS_STG_ADMIN_KEY }}
          AMOUNT: 100
        run: ./scripts/lnbits-smoke.sh "${AMOUNT:-100}"

  real-relay-comment:
    name: Real Relay Comment (opt-in)
    if: secrets.REAL_RELAY != '' && secrets.NIP07_PROFILE_B64 != ''
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright (if not cached)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: apps/social
        run: pnpm exec playwright install --with-deps chromium

      - name: Restore NIP-07 profile
        run: |
          echo "$NIP07_PROFILE_B64" | base64 -d > /tmp/nip07-profile.zip
          mkdir -p /tmp/nip07-profile
          unzip -q /tmp/nip07-profile.zip -d /tmp/nip07-profile
        env:
          NIP07_PROFILE_B64: ${{ secrets.NIP07_PROFILE_B64 }}

      - name: Real relay comment test
        working-directory: apps/social
        env:
          REAL_RELAY: ${{ secrets.REAL_RELAY }}
          VITE_NOSTRSTACK_RELAYS: ${{ secrets.REAL_RELAY }}
          VITE_API_BASE_URL: mock
          VITE_NOSTRSTACK_HOST: mock
          CHROMIUM_USER_DATA_DIR: /tmp/nip07-profile
        run: pnpm exec playwright test tests/comment-relay.spec.ts --project=chromium --retries=2 --reporter=line
