name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'LICENSE'
      - 'CHANGELOG.md'
      - 'changelog/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'LICENSE'
      - 'CHANGELOG.md'
      - 'changelog/**'
  workflow_dispatch:
    inputs:
      run_extended_checks:
        description: Run extended checks (slow/optional lint + external jobs)
        type: boolean
        default: false
      run_external_checks:
        description: Run external integration checks (LNbits + real relay)
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Lint (GitHub Actions Workflows)
            tool: actionlint
            allow_failure: false
            command: echo "skip actionlint command step"
          - name: Lint (Knip)
            command: pnpm lint:knip
            allow_failure: true
            extended: true
          - name: Lint (Copy/Paste)
            command: pnpm lint:cpd
            allow_failure: false
          - name: Lint (File Naming)
            command: pnpm lint:ls
            allow_failure: false
          - name: Lint (Spell Check)
            command: pnpm lint:spell
            allow_failure: false
          - name: Lint (CSS)
            command: pnpm lint:css
            allow_failure: false
          - name: Lint (Markdown)
            command: pnpm lint:md
            allow_failure: false
          - name: Lint (Shell Scripts)
            command: pnpm lint:sh
            install_shellcheck: true
            allow_failure: false
          - name: Lint (Secrets)
            command: pnpm lint:secrets
            allow_failure: false
          - name: Lint (Audit)
            command: pnpm lint:audit
            allow_failure: false
            extended: true
          - name: Lint (Dependencies)
            command: pnpm lint:deps
            allow_failure: false
            extended: true
          - name: Lint (Architecture)
            command: pnpm lint:dep
            allow_failure: false
            extended: true
    permissions:
      contents: read
    continue-on-error: ${{ matrix.allow_failure == true }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Lint (GitHub Actions Workflows)
        if: matrix.tool == 'actionlint'
        uses: reviewdog/action-actionlint@v1
        with:
          fail_level: error
          filter_mode: nofilter

      - name: Install shellcheck
        if: matrix.install_shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: ${{ matrix.name }}
        if: |
          matrix.command != '' &&
          (
            matrix.extended != true ||
            (github.event_name == 'workflow_dispatch' && inputs.run_extended_checks == true) ||
            (github.event_name == 'pull_request' &&
              (contains(github.event.pull_request.labels.*.name, 'run-extended-checks')))
          )
        run: ${{ matrix.command }}

  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: TypeCheck
        run: pnpm typecheck

      - name: Lint (Publishing)
        run: pnpm lint:pub

      - name: Lint (Types)
        run: pnpm lint:attw

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Generate Prisma Client
        working-directory: apps/api
        env:
          DATABASE_URL: file:./test.db
          PRISMA_SCHEMA_FILE: prisma/schema.prisma
        run: pnpm prisma:generate

      - name: Cache Vitest
        uses: actions/cache@v4
        with:
          path: /tmp/nostrstack/vitest
          key: vitest-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            vitest-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Unit Tests
        env:
          DATABASE_URL: file:./test.db
          ADMIN_API_KEY: test-admin
          OP_NODE_API_KEY: test-key
          OP_NODE_WEBHOOK_SECRET: whsec_test
          XDG_CACHE_HOME: /tmp
        run: pnpm test:ci

  smoke-lnbits:
    name: LNbits Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    if: >
      (github.event_name == 'workflow_dispatch' &&
        (inputs.run_external_checks == true || inputs.run_extended_checks == true))
      || (github.event_name == 'pull_request' &&
        (contains(github.event.pull_request.labels.*.name, 'run-smoke-tests') ||
         contains(github.event.pull_request.labels.*.name, 'run-extended-checks')))
    steps:
      - uses: actions/checkout@v4

      - name: Mutinynet smoke (staging LNbits)
        env:
          LNBITS_URL: https://lnbits-stg-west.thankfulwater-904823f2.westus3.azurecontainerapps.io
          LNBITS_ADMIN_KEY: ${{ secrets.LNBITS_STG_ADMIN_KEY }}
          AMOUNT: 100
        run: |
          if [ -z "${LNBITS_ADMIN_KEY:-}" ]; then
            echo "Skipping LNbits smoke test because LNBITS_STG_ADMIN_KEY is not set"
            exit 0
          fi
          ./scripts/lnbits-smoke.sh "${AMOUNT:-100}"

  real-relay-comment:
    name: Real Relay Comment (opt-in)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    if: >
      (github.event_name == 'workflow_dispatch' &&
        (inputs.run_external_checks == true || inputs.run_extended_checks == true))
      || (github.event_name == 'pull_request' &&
        (contains(github.event.pull_request.labels.*.name, 'run-smoke-tests') ||
         contains(github.event.pull_request.labels.*.name, 'run-extended-checks')))
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright (if not cached)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: apps/social
        run: pnpm exec playwright install --with-deps chromium

      - name: Restore NIP-07 profile
        env:
          NIP07_PROFILE_B64: ${{ secrets.NIP07_PROFILE_B64 }}
        run: |
          if [ -z "${NIP07_PROFILE_B64:-}" ]; then
            echo "Skipping real relay comment test because NIP07_PROFILE_B64 is not set"
            exit 0
          fi
          echo "$NIP07_PROFILE_B64" | base64 -d > /tmp/nip07-profile.zip
          mkdir -p /tmp/nip07-profile
          unzip -q /tmp/nip07-profile.zip -d /tmp/nip07-profile

      - name: Real relay comment test
        env:
          REAL_RELAY: ${{ secrets.REAL_RELAY }}
          VITE_NOSTRSTACK_RELAYS: ${{ secrets.REAL_RELAY }}
          VITE_API_BASE_URL: mock
          VITE_NOSTRSTACK_HOST: mock
          CHROMIUM_USER_DATA_DIR: /tmp/nip07-profile
        working-directory: apps/social
        run: |
          if [ -z "${REAL_RELAY:-}" ]; then
            echo "Skipping real relay comment test because REAL_RELAY is not set"
            exit 0
          fi
          pnpm exec playwright test tests/comment-relay.spec.ts --project=chromium --retries=2 --reporter=line
