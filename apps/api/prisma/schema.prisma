datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id          String    @id @default(cuid())
  domain      String    @unique
  displayName String
  lnurlSuccessAction String?
  lnurlCommentAllowed Int?
  lnurlMetadata String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  users       User[]
  payments    Payment[]
  lnurlWithdrawSessions LnurlWithdrawSession[]
}

model User {
  id               String    @id @default(cuid())
  tenantId         String
  pubkey           String
  lightningAddress String?
  lnurlSuccessAction String?
  lnurlCommentAllowed Int?
  lnurlMetadata String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  tenant           Tenant    @relation(fields: [tenantId], references: [id])
  payments         Payment[]

  @@unique([tenantId, pubkey])
  @@unique([tenantId, lightningAddress])
}

model Payment {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String?
  provider    String
  providerRef String
  invoice     String   @unique
  action      String?
  itemId      String?
  amountSats  Int
  status      String   @default("PENDING")
  metadata    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  @@unique([provider, providerRef, tenantId])
  @@index([tenantId])
  @@index([tenantId, action])
  @@index([tenantId, action, itemId])
  @@index([tenantId, userId])
}

model LnurlAuthSession {
  id         String   @id @default(cuid())
  k1         String   @unique
  linkingKey String?
  status     String   @default("PENDING")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
  @@index([expiresAt])
}

model LnurlWithdrawSession {
  id                 String   @id @default(cuid())
  tenantId           String
  k1                 String   @unique
  minWithdrawable    Int
  maxWithdrawable    Int
  defaultDescription String?
  status             String   @default("PENDING")
  expiresAt          DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([expiresAt])
}
