datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id          String    @id @default(cuid())
  domain      String    @unique
  displayName String
  lnurlSuccessAction String?
  lnurlCommentAllowed Int?
  lnurlMetadata String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  users       User[]
  payments    Payment[]
  lnurlWithdrawSessions LnurlWithdrawSession[]
}

model User {
  id               String    @id @default(cuid())
  tenantId         String
  pubkey           String
  lightningAddress String?
  lnurlSuccessAction String?
  lnurlCommentAllowed Int?
  lnurlMetadata String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments         Payment[]

  @@unique([tenantId, pubkey])
  @@unique([tenantId, lightningAddress])
}

model Payment {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String?
  provider    String
  providerRef String
  invoice     String   @unique
  action      String?
  itemId      String?
  amountSats  Int
  status      String   @default("PENDING")
  metadata    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([provider, providerRef, tenantId])
  @@index([tenantId])
  @@index([tenantId, action])
  @@index([tenantId, action, itemId])
  @@index([tenantId, userId])
}

model LnurlAuthSession {
  id         String   @id @default(cuid())
  k1         String   @unique
  linkingKey String?
  status     String   @default("PENDING")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
  @@index([expiresAt])
}

model LnurlWithdrawSession {
  id                 String   @id @default(cuid())
  tenantId           String
  k1                 String   @unique
  minWithdrawable    BigInt
  maxWithdrawable    BigInt
  defaultDescription String?
  status             String   @default("PENDING")
  expiresAt          DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([expiresAt])
}

model NostrEventCache {
  id        String   @id @default(cuid())
  eventId   String   @unique
  eventJson String
  pubkey    String
  kind      Int
  relays    String?
  fetchedAt DateTime
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model NostrAddressCache {
  id         String   @id @default(cuid())
  kind       Int
  pubkey     String
  identifier String
  eventId    String
  eventJson  String
  relays     String?
  fetchedAt  DateTime
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([kind, pubkey, identifier])
  @@index([eventId])
  @@index([expiresAt])
}

model Nip05Cache {
  id         String   @id @default(cuid())
  cacheKey   String   @unique
  pubkey     String
  relays     String?
  nip05      String
  name       String
  domain     String
  fetchedAt  DateTime
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([expiresAt])
}

model Bolt12Offer {
  id          String   @id @default(cuid())
  description String
  amountMsat  Int?
  label       String?
  issuer      String?
  expiresIn   Int?
  offer       String
  offerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdAt])
}
